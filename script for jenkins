pipeline {
    agent any
    tools{
        jdk 'jdk17'
        maven 'maven'
    }
    environment{
        SCANNER_HOME= tool ('sonar-scanner')
    }

    stages {
        stage('Git Check') {
            steps {
                git branch: 'main', changelog: false, poll: false, url: 'https://github.com/dhamuhema/Maven-Tomcat-Nexus-Sonar-Setup.git'
            }
        }
         stage('Maven Clean Compile') {
            steps {
                sh "mvn clean compile"
            }
        }
        stage('Maven Test') {
            steps {
                sh "mvn test"
            }
        }
         stage('Sonarqube Analysis') {
            steps {
                withSonarQubeEnv('sonar-server') {
                     sh ''' $SCANNER_HOME/bin/sonar-scanner -Dsonar.ProjectName=Maven-Tomcat-Nexus-Sonar-Setup \
                     -Dsonar.java.binaries=. \
                     -Dsonar.projectKey=Maven-Tomcat-Nexus-Sonar-Setup '''
                }
            }
        }
        stage('Maven Package') {
            steps {
                sh "mvn package"
            }
        }
        stage('owasp Dependency Check') {
            steps {
                dependencyCheck additionalArguments: '--scan target/', odcInstallation: 'owasp'
                dependencyCheckPublisher pattern: '**\\dependency-check-report.xml'
            }
        }
        stage('Deploy To Nexus') {
            steps {
               nexusArtifactUploader artifacts: [[artifactId: 'mavenreleasearitifactid', classifier: '', file: 'target/java-tomcat-maven-example.war', type: 'war']], credentialsId: 'nexusrepository', groupId: 'com.maven-releases.app', nexusUrl: '3.80.120.177:8081', nexusVersion: 'nexus3', protocol: 'http', repository: 'maven-releases', version: '2.1.2-maven-releases'   
            }
        }
        stage('Deploy to Tomcat') {
            steps {
                deploy adapters: [tomcat9(credentialsId: '522a3304-0cc1-40cb-8844-14908b1410c5', path: '', url: 'http://3.80.120.177:8089/')], contextPath: 'Maven-Tomcat-Nexus-Sonar-Setup', war: '**/*.war'
            }
        }
    }
}
